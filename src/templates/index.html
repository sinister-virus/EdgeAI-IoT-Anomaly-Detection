<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge-AI Smart Home SOC</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for dynamic graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soc-bg': '#1e293b',    // Slate-800
                        'soc-card': '#334155',  // Slate-700
                        'soc-primary': '#60a5fa', // Blue-400 for primary actions
                        'soc-alert': '#f87171', // Red-400 for anomalies
                        'soc-safe': '#4ade80',  // Green-400 for safe status
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for a cleaner SOC look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #334155; }
        ::-webkit-scrollbar-thumb { background: #60a5fa; border-radius: 4px; }
        .table-container { max-height: 400px; overflow-y: auto; }
    </style>
</head>

<body class="bg-soc-bg text-gray-100 font-sans p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 border-b border-soc-card pb-4 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-soc-primary tracking-tight">Edge-AI Smart Home SOC</h1>
                <p class="text-gray-400 text-sm mt-1">Autonomous Intrusion Detection & Device Management</p>
            </div>
            <div class="text-right">
                <span id="update-status" class="text-xs font-mono text-soc-safe animate-pulse">● Live: Connected</span>
                <br>
                <a href="/device_events" class="text-xs text-gray-400 hover:text-white underline mt-1">View Full History &rarr;</a>
            </div>
        </header>

        <!-- KPI Summary Cards -->
        <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Devices -->
            <div class="bg-soc-card p-5 rounded-lg shadow-lg border-l-4 border-soc-primary transform hover:scale-105 transition-transform">
                <p class="text-xs text-gray-400 uppercase font-semibold tracking-wider">Connected Devices</p>
                <p id="total-devices" class="text-3xl font-extrabold mt-2">--</p>
            </div>
            <!-- Total Anomalies -->
            <div class="bg-soc-card p-5 rounded-lg shadow-lg border-l-4 border-soc-alert transform hover:scale-105 transition-transform">
                <p class="text-xs text-gray-400 uppercase font-semibold tracking-wider">Active Threats</p>
                <p id="total-anomalies" class="text-3xl font-extrabold mt-2 text-soc-alert">--</p>
            </div>
            <!-- Average Usage -->
            <div class="bg-soc-card p-5 rounded-lg shadow-lg border-l-4 border-purple-400 transform hover:scale-105 transition-transform">
                <p class="text-xs text-gray-400 uppercase font-semibold tracking-wider">Avg Bandwidth</p>
                <p id="avg-usage" class="text-3xl font-extrabold mt-2">--</p>
            </div>
            <!-- Overall Risk Score -->
            <div class="bg-soc-card p-5 rounded-lg shadow-lg border-l-4 border-soc-safe" id="risk-card">
                <p class="text-xs text-gray-400 uppercase font-semibold tracking-wider">Network Risk Score</p>
                <p id="overall-risk" class="text-3xl font-extrabold mt-2">--</p>
            </div>
        </div>

        <!-- Charts Section (Real-time Visualization) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Chart 1: Device Count by Type -->
            <div class="lg:col-span-1 bg-soc-card p-4 rounded-lg shadow-xl flex flex-col">
                <h3 class="text-lg font-semibold mb-4 text-gray-200">Device Distribution</h3>
                <div class="flex-grow relative" style="min-height: 250px;">
                    <canvas id="deviceDistributionChart"></canvas>
                </div>
            </div>
            <!-- Chart 2: Traffic Timeline (REPLACED BUBBLE CHART) -->
            <div class="lg:col-span-2 bg-soc-card p-4 rounded-lg shadow-xl flex flex-col">
                <h3 class="text-lg font-semibold mb-4 text-gray-200">Real-Time Traffic & Risk Timeline</h3>
                <div class="flex-grow relative" style="min-height: 250px;">
                    <canvas id="networkTrafficChart"></canvas>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">Bars = Bandwidth Usage (KB) | Line = Security Risk (%)</p>
            </div>
        </div>

        <!-- Live Log Feed (Anomaly Alerts Panel) -->
        <div class="bg-soc-card p-6 rounded-lg shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2 animate-ping"></span>
                    Live Event Feed
                </h2>
                <button onclick="fetchData(true)" class="bg-soc-primary hover:bg-blue-600 text-white text-xs font-bold py-2 px-4 rounded-full shadow-md transition duration-150 flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Refresh Now
                </button>
            </div>

            <div class="table-container rounded-lg border border-gray-700">
                <table class="w-full text-sm text-left table-auto">
                    <thead class="sticky top-0 bg-gray-800 text-gray-300 uppercase text-xs">
                        <tr>
                            <th scope="col" class="px-4 py-3">Timestamp</th>
                            <th scope="col" class="px-4 py-3">Device Name</th>
                            <th scope="col" class="px-4 py-3">Usage (KB)</th>
                            <th scope="col" class="px-4 py-3">Risk Score</th>
                            <th scope="col" class="px-4 py-3 text-center">Status</th>
                            <th scope="col" class="px-4 py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="logs-tbody" class="divide-y divide-gray-700">
                        <!-- Logs populated by JavaScript -->
                        <tr class="text-gray-400"><td colspan="6" class="py-8 text-center animate-pulse">Waiting for incoming logs...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JavaScript for Dynamic Data and Charting -->
    <script>
        // Global Chart Instances
        let distributionChart;
        let trafficChart; // Renamed from riskUsageChart

        // --- UTILITY FUNCTIONS ---

        // Helper function to get color based on risk score
        function getRiskColor(score) {
            const risk = parseFloat(score);
            if (risk > 0.8) return '#f87171'; // Red (High Risk)
            if (risk > 0.5) return '#fbbf24'; // Yellow (Medium Risk)
            return '#4ade80'; // Green (Safe)
        }

        function triggerAction(deviceMac, deviceName) {
            if(!confirm(`Are you sure you want to ISOLATE device: ${deviceName}?`)) return;

            fetch('/api/take_action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'ISOLATE', device_mac: deviceMac, device_name: deviceName })
            })
            .then(response => response.json())
            .then(data => alert(data.message))
            .catch(err => console.error('Action failed:', err));
        }

        // --- DATA FETCHING & RENDERING ---

        async function fetchSummaryStats() {
            try {
                const response = await fetch('/api/summary_stats');
                const data = await response.json();

                document.getElementById('total-devices').textContent = data.total_devices;
                document.getElementById('total-anomalies').textContent = data.total_anomalies;
                document.getElementById('avg-usage').textContent = data.average_usage;
                document.getElementById('overall-risk').textContent = `${data.overall_risk_pct}%`;

                // Dynamic border color for risk card based on severity
                const riskCard = document.getElementById('risk-card');
                riskCard.className = `bg-soc-card p-5 rounded-lg shadow-lg border-l-4 transform hover:scale-105 transition-transform ${data.overall_risk_pct > 50 ? 'border-soc-alert' : 'border-soc-safe'}`;

                updateDistributionChart(data.device_counts);

            } catch (error) {
                console.error("Error fetching summary stats:", error);
            }
        }

        async function fetchLiveLogs() {
            try {
                const response = await fetch('/api/latest_logs');
                const logs = await response.json();
                const tbody = document.getElementById('logs-tbody');

                if (logs.length === 0) {
                    tbody.innerHTML = `<tr class="text-gray-400"><td colspan="6" class="py-8 text-center">No logs available. System is listening...</td></tr>`;
                    return;
                }

                tbody.innerHTML = ''; // Clear existing rows

                // --- PREPARE TIMELINE DATA (Reversed to show chronological order left-to-right) ---
                const chronologicalLogs = [...logs].reverse(); // Clone and reverse
                const labels = chronologicalLogs.map(log => {
                    // Extract just HH:MM:SS from timestamp for clearer X-axis
                    return log.timestamp.split(' ')[1] || log.timestamp;
                });
                const usageData = chronologicalLogs.map(log => log.usage);
                const riskData = chronologicalLogs.map(log => (log.risk_score * 100).toFixed(1));

                updateTrafficChart(labels, usageData, riskData);

                // Render log table rows (Keep standard order: Newest first)
                logs.forEach(log => {
                    const isAnomaly = log.anomaly_flag === 'YES';
                    const riskColor = getRiskColor(log.risk_score);
                    const riskPercent = (log.risk_score * 100).toFixed(1);
                    const statusLabel = isAnomaly ? 'THREAT' : 'Normal';

                    const row = document.createElement('tr');
                    row.className = `hover:bg-gray-700 transition-colors ${isAnomaly ? 'bg-red-900/20' : ''}`;

                    row.innerHTML = `
                        <td class="px-4 py-3 font-mono text-xs text-gray-300">${log.timestamp}</td>
                        <td class="px-4 py-3 font-medium text-white">${log.device || 'Unknown'}</td>
                        <td class="px-4 py-3 text-gray-300">${log.usage}</td>
                        <td class="px-4 py-3 font-bold" style="color: ${riskColor};">${riskPercent}%</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${isAnomaly ? 'bg-red-900 text-red-200 border border-red-700' : 'bg-green-900 text-green-200 border border-green-700'}">
                                ${statusLabel}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            ${isAnomaly ?
                                `<button onclick="triggerAction('${log.device_mac}', '${log.device}')" class="text-xs bg-red-600 hover:bg-red-700 text-white py-1 px-2 rounded border border-red-500 shadow-sm">ISOLATE</button>`
                                : '<span class="text-gray-600">-</span>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("Error fetching live logs:", error);
            }
        }

        function fetchData(manual = false) {
            const status = document.getElementById('update-status');
            if (!manual) {
                status.textContent = '● Live: Updating...';
                status.classList.remove('text-soc-safe', 'animate-pulse');
                status.classList.add('text-yellow-400');
            }

            Promise.all([fetchSummaryStats(), fetchLiveLogs()])
                .finally(() => {
                    status.textContent = '● Live: Connected';
                    status.classList.remove('text-yellow-400');
                    status.classList.add('text-soc-safe', 'animate-pulse');
                });
        }

        // --- CHART CONFIGURATION ---

        function initCharts() {
            // Chart 1: Device Distribution
            const ctx1 = document.getElementById('deviceDistributionChart').getContext('2d');
            distributionChart = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } }
                    },
                }
            });

            // Chart 2: Network Traffic Timeline (Dual Axis: Usage & Risk)
            const ctx2 = document.getElementById('networkTrafficChart').getContext('2d');
            trafficChart = new Chart(ctx2, {
                type: 'bar', // Base type
                data: {
                    labels: [], // Timestamps
                    datasets: [
                        {
                            label: 'Bandwidth Usage (KB)',
                            data: [],
                            backgroundColor: 'rgba(96, 165, 250, 0.5)', // Blue-400 transparent
                            borderColor: '#60a5fa',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Risk Score (%)',
                            data: [],
                            type: 'line', // Mixed chart type
                            borderColor: '#f87171', // Red-400
                            backgroundColor: 'rgba(248, 113, 113, 0.2)',
                            borderWidth: 2,
                            tension: 0.4, // Smooth curves
                            pointRadius: 0, // Clean line
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        x: {
                            ticks: { color: '#64748b', maxTicksLimit: 10 },
                            grid: { display: false, borderColor: '#334155' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Usage (KB)', color: '#60a5fa' },
                            ticks: { color: '#64748b' },
                            grid: { color: '#334155' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Risk (%)', color: '#f87171' },
                            min: 0, max: 100,
                            ticks: { color: '#64748b' },
                            grid: { drawOnChartArea: false } // Avoid grid clutter
                        }
                    }
                }
            });
        }

        function updateDistributionChart(deviceCounts) {
            const labels = Object.keys(deviceCounts);
            const data = Object.values(deviceCounts);
            const colors = labels.map((_, i) => ['#4ade80', '#60a5fa', '#f87171', '#fbbf24', '#c084fc'][i % 5]);

            distributionChart.data.labels = labels;
            distributionChart.data.datasets[0].data = data;
            distributionChart.data.datasets[0].backgroundColor = colors;
            distributionChart.update();
        }

        function updateTrafficChart(labels, usageData, riskData) {
            trafficChart.data.labels = labels;
            trafficChart.data.datasets[0].data = usageData; // Bar: Usage
            trafficChart.data.datasets[1].data = riskData;  // Line: Risk
            trafficChart.update('none'); // 'none' mode prevents annoying animation jitter on refresh
        }


        // --- INITIALIZATION ---
        window.onload = function() {
            initCharts();
            fetchData();
            // Poll API every 5 seconds
            setInterval(fetchData, 5000);
        };
    </script>
</body>
</html>